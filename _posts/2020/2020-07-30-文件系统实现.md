---
title: 文件系统实现
layout: post
categories: [操作系统]
keywords: 文件系统
---

> 本文是[Operating Systems: Three Easy Pieces](http://pages.cs.wisc.edu/~remzi/OSTEP/)的阅读笔记

### 整体组织

首先，将磁盘划分为一个个块，块大小为 4KB，这也是很多文件系统普遍使用的块大小。将上述划分的块编号为 0 至 N-1，则该文件系统的大小为 N 个 4KB。

假设我们的磁盘的大小只能划分为 64 块。文件系统嘛，就是用来存储用户数据的，我们将存储用户数据的区域称为`data region`。另外，为了简便，将 64 块中靠后的 56 块用作`data region`，如下图所示。

![data region](/assets/images/2020/0730/WX20200729-173825.png)

文件系统需要追踪每个文件的信息，如组成文件的数据块（在`data region`中）、文件大小、所有者和访问权限、访问和修改时间及其它相关信息。文件系统通常用一个叫`inode`的结构来存储这些信息。为了容纳`inode`，需要在磁盘中保留一些空间，我们将这部分空间称为`inode table`，`inode table`只是简单地保存`inode`的数组。我们用 64 块中的 5 块来存储`inode`。

![inode table](/assets/images/2020/0730/WX20200729-174449.png)

`inode`都不大，一般是 128 或 256 字节。假设每个`inode`都是 256 字节，一个 4KB 的块可以保存 16 个`inode`，则我们的磁盘有 5 * 16 = 80 个`inode`，`inode`的数量表示文件系统的最大文件数量。

现在已经有了数据块和`inode`了，还缺少了一个基本的组件，就是以某些方式追踪数据块或`inode`是空闲还是已分配，这种`allocation structures`是任何系统都必不可少的。下面我们使用位图`bitmap`来追踪，一个用于`data region`，另一个用于`inode table`，也就是下图中的`d`和`i`。

![allocation structures](/assets/images/2020/0730/WX20200729-180104.png)

位图使用了整个 4KB 的块，一个位图可以追踪 4 * 8 * 2^10 = 32 * 2^10 个分配对象。当然，我们现在只有 56 个数据块以及 80 个`inode`。

现在文件系统中还有一个块仍未使用，我们将这块用作`superblock`，在下图用`S`表示。`superblock`包含了文件系统的信息，比如数据块和`inode`的数量（分别是 56 和 80），`inode table`的开始位置（第 3 块），表示文件类型的`magic number`等等。

![superblock](/assets/images/2020/0730/WX20200729-180834.png)

在挂载文件系统时，操作系统会首先读取`superblock`，初始化参数，然后将卷附加到文件系统树。当访问卷内文件时，系统将准确地知道在哪里查找所需的磁盘结构。

### 文件组织：inode

文件系统最重要的磁盘结构之一是 inode，几乎所有的文件系统都有类似的结构。名称 inode 是 index node（索引节点）的缩写，它是由 UNIX 开发人员 Ken Thompson 给出的历史性名称，因为这些节点最初放在一个数组中，在访问特定 inode 时会用到该数组的索引。

每个 inode 都由一个数字（称为 inumber）隐式引用，我们称之为文件的低级名称(low-level name)。在 VSFS（和其他简单的文件系统）中，给定一个 inumber，应该能够直接计算磁盘上相应节点的位置。例如，要获取 VSFS 的 inode 表：大小为 20KB（5 个 4KB 块），因此由 80 个 inode（假设每个 inode 为 256 字节）组成。进一步假设 inode 区域从 12KB 开始（即超级块从 0KB 开始，inode 位图在 4KB 位置，数据位图在 8KB，因此 inode 表紧随其后）。因此，在 VSFS 中，我们为文件系统分区的开头提供了以下布局（特写视图）：

![inode](/assets/images/2020/0817/20200817-183319.png)

要读取 inode 号 32，文件系统首先会计算 inode 区域的偏移量（32 X inode 的大小，即 32 X 256 = 8192），将它加上磁盘 inode 表的起始地址（12 KB），从而得到希望的 inode 块的正确字节地址：20 KB。由于磁盘不是按字节寻址的，而是由大量可寻址扇区组成，通常是 512 字节。因此，为了获取包含索引节点 32 的索引节点块，文件系统将向节点（即 40，之所以是 40，是因为 20KB = 2 X 20 X 512 ＝ 40 X 512）发出一个读取请求，取得期望的 inode 块。

在每个 inode 中，实际上是所有关于文件的信息：文件类型（例如，常规文件、目录等）、大小、分配给它的块数、保护信息、一些时间信息，以及在关其数据块驻留在磁盘上的位置信息。我们将所有关于文件的信息称为`元数据(metadata)`。实际上，文件系统中除了纯粹的用户数据外，其他任何信息通常都称为元数据。

### 目录组织

在 VSFS 中（像许多文件系统一样），目录的组织很简单。一个目录基本上只包含一个二元组（条目名称，inode 号）的列表。对于给定目录中的每个文件或目录，目录的数据块中都有一个字符和一个数字。对于每个字符串，可能还有一个长度（假定采用可变大小的名称）。

例如，目录 dir（inode 号是 5）中有 3 个文件（foo、bar 和 foobar），它们的 inode 号分别是 12、13 和 24。dir 在磁盘上的数据可能如下所示：

|	inum	|	reclen	|	strlen	|	name	|
| :--: | :--: | :--: | :--: |
| 5 | 4 | 2 | . |
| 2 | 4 | 3 | .. |
| 12 | 4 | 4 | foo |
| 13 | 4 | 4 | bar |
| 24 | 8 | 7 | foobar |

上表每个条目都有一个 inode 号，记录长度（名称的总字节数加上所有的剩余空间），字符串长度（名称的实际长度），最后是条目的名称。
