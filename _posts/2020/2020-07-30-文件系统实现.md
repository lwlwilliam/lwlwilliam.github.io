---
title: 文件系统实现
layout: post
categories: [操作系统]
keywords: 文件系统
---

> 本文是[Operating Systems: Three Easy Pieces](http://pages.cs.wisc.edu/~remzi/OSTEP/)的阅读笔记

### 整体组织

首先，将磁盘划分为一个个块，块大小为 4KB，这也是很多文件系统普遍使用的块大小。将上述划分的块编号为 0 至 N-1，则该文件系统的大小为 N 个 4KB。

假设我们的磁盘的大小只能划分为 64 块。文件系统嘛，就是用来存储用户数据的，我们将存储用户数据的区域称为`data region`。另外，为了简便，将 64 块中靠后的 56 块用作`data region`，如下图所示。

![data region](/assets/images/2020/0730/WX20200729-173825.png)

文件系统需要追踪每个文件的信息，如组成文件的数据块（在`data region`中）、文件大小、所有者和访问权限、访问和修改时间及其它相关信息。文件系统通常用一个叫`inode`的结构来存储这些信息。为了容纳`inode`，需要在磁盘中保留一些空间，我们将这部分空间称为`inode table`，`inode table`只是简单地保存`inode`的数组。我们用 64 块中的 5 块来存储`inode`。

![inode table](/assets/images/2020/0730/WX20200729-174449.png)

`inode`都不大，一般是 128 或 256 字节。假设每个`inode`都是 256 字节，一个 4KB 的块可以保存 16 个`inode`，则我们的磁盘有 5 * 16 = 80 个`inode`，`inode`的数量表示文件系统的最大文件数量。

现在已经有了数据块和`inode`了，还缺少了一个基本的组件，就是以某些方式追踪数据块或`inode`是空闲还是已分配，这种`allocation structures`是任何系统都必不可少的。下面我们使用位图`bitmap`来追踪，一个用于`data region`，另一个用于`inode table`，也就是下图中的`d`和`i`。

![allocation structures](/assets/images/2020/0730/WX20200729-180104.png)

位图使用了整个 4KB 的块，一个位图可以追踪 4 * 8 * 2^10 = 32 * 2^10 个分配对象。当然，我们现在只有 56 个数据块以及 80 个`inode`。

现在文件系统中还有一个块仍未使用，我们将这块用作`superblock`，在下图用`S`表示。`superblock`包含了文件系统的信息，比如数据块和`inode`的数量（分别是 56 和 80），`inode table`的开始位置（第 3 块），表示文件类型的`magic number`等等。

![superblock](/assets/images/2020/0730/WX20200729-180834.png)

在挂载文件系统时，操作系统会首先读取`superblock`，初始化参数，然后将卷附加到文件系统树。当访问卷内文件时，系统将准确地知道在哪里查找所需的磁盘结构。