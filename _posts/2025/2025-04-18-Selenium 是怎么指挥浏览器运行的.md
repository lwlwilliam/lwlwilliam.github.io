---
title: Selenium 是怎么指挥浏览器运行的
layout: post
categories: [工具]
keywords: 工具
---

（todo）写过爬虫或者做自动化测试的相信对`Selenium`不会陌生，但`Selenium`官方只提供少数几种语言的库，使用其它“小众”语言的只能眼馋。既然如此，那就自己琢磨一下能不能搞个类似的吧，毕竟大家都是图灵完备的语言，除了少数一些领域实在没办法或者几乎不可能做到之外，其它的都大差不差。

“小小”的语言能唤起浏览器，有经验的大家都知道还有个前提就是下载浏览器驱动。

```php
<?php

function request($method, $url, $data = null)
{
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $method);
    if ($data !== null) {
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    }
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $res = curl_exec($ch);
    curl_close($ch);
    return json_decode($res, true);
}

//
// // 1. 启动 chromedriver 子进程
// $descriptorspec = [
//     0 => ['pipe', 'r'], // stdin
//     1 => ['pipe', 'w'], // stdout
//     2 => ['pipe', 'w'], // stderr
// ];
// 
// $process = proc_open('/Users/wu/Desktop/chromedriver2/chromedriver --port=9515', $descriptorspec, $pipes);
// 
// // 检查是否启动成功
// if (!is_resource($process)) {
//     die("无法启动 chromedriver\n");
// }
// 
// // 2. 等待 chromedriver 启动（你可以做更优雅的端口检测）
// sleep(1); // 简单粗暴等 1 秒

$baseUrl = 'http://localhost:9516';

// 3. 创建 session
$session = request('POST', "$baseUrl/session", [
    'capabilities' => [
        'alwaysMatch' => [
            'browserName' => 'chrome',
        ],
    ]
]);

var_dump($session);

if (!isset($session['value']['sessionId'])) {
    echo "无法创建浏览器 session\n";
    proc_terminate($process);
    exit(1);
}


$sessionId = $session['value']['sessionId'];
echo "Session ID: $sessionId\n";

// 4. 打开网页
request('POST', "$baseUrl/session/$sessionId/url", [
    'url' => 'https://example.com',
]);

sleep(5);

// 5. 获取标题
$title = request('GET', "$baseUrl/session/$sessionId/title");
echo "页面标题: " . $title['value'] . "\n";

// 6. 退出浏览器
request('DELETE', "$baseUrl/session/$sessionId");

// 7. 杀掉 chromedriver 进程
// proc_terminate($process);

echo "完成！\n";
```
