---
title: 一个简单的 RPC 示例
layout: post
categories: [计算机网络]
keywords: RPC,网络
---

远程过程调用——`RPC(Remote Procedure Call)`，在《UNIX 网络编程》一书中是这样描述的：被调用过程和调用过程处于不同的进程中，一个进程调用同一台主机上另一个进程的某个过程（函数）。`RPC`通常允许一台主机上的某个客户调用另一台主机上的某个服务器过程，只要这两台主机以某种形式的网络连接着。


### RPC 服务端

`Test`是示范服务端中被客户端调用的类；`RPCServer`用于接收`RPCClient`请求并解释、代替客户端调用类方法。

```php
// RPCServer.php
<?php

class Test
{
    public function say(string $name, string $message): string
    {
        return "$name: $message";
    }

    public function hello(): string
    {
        return 'Hello world';
    }
}

class RPCServer
{
    private $socket;

    /**
     * @throws Exception
     */
    public function __construct(string $host, int $port)
    {
        $this->socket = stream_socket_server("tcp://$host:$port", $errno, $error);
        if (!$this->socket) {
            throw new Exception("$errno: $error");
        }

        socket_set_blocking($this->socket, true);
        while (true) {
            $client = stream_socket_accept($this->socket, -1);

            if ($client) {
                $buf = fread($client, 1024);
                $json = json_decode($buf, true);

                if (
                    isset($json['class'], $json['method'], $json['params'])
                    && is_string($json['class']) && is_string($json['method']) && is_array($json['params'])
                ) {
                    if (class_exists($json['class'])) {
                        $obj = new $json['class']();
                        $method = $json['method'];
                        if (method_exists($obj, $method)) {
                            try {
                                $res = $obj->{$method}(...$json['params']);
                                fwrite($client, json_encode($res));
                            } catch (Throwable $e) {
                                fwrite($client, $e->getMessage());
                            }
                        } else {
                            fwrite($client, '"method not exist"');
                        }
                    } else {
                        fwrite($client, '"class not exist"');
                    }
                } else {
                    fwrite($client, '"protocol error"');
                }

                fclose($client);
            }
        }
    }

    public function __destruct()
    {
        fclose($this->socket);
    }
}

try {
    new RPCServer('127.0.0.1', 10240);
} catch (Throwable $e) {
    echo $e->getMessage(), "\n";
}
```


```bash
$ php RPCServer.php
```


### RPC 客户端

`Test`是一个伪类，主要作用就是提供`IDE`提示，其中的文档注释对代码开发特别友好，实际上去掉也不影响功能完整性；`RPCClient`作为代理，发起远程过程调用；`Factory`起到隐藏网络细节的作用，让用户误以为这只是一个本地的调用。

```php
<?php
// RPCClient.php

/**
 * @method string say(string $param1, string $param2)
 * @method string hello()
 */
class Test
{

}

class RPCClient
{
    private string $host;
    private int $port;
    private string $class;

    function __construct(string $host, int $port, string $class)
    {
        $this->host = $host;
        $this->port = $port;
        $this->class = $class;
    }

    /**
     * @throws Exception
     */
    function __call(string $method, $params)
    {
        // 创建一个客户端
        $client = stream_socket_client("tcp://$this->host:$this->port", $errno, $error);
        if (!$client) {
            throw new Exception("$errno: $error");
        }

        $json = json_encode([
            'class' => $this->class,
            'method' => $method,
            'params' => $params,
        ], JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);

        fwrite($client, $json);
        $data = fread($client, 1024);
        fclose($client);
        return $data;
    }
}

class Factory
{
    public static function create(string $class): RPCClient
    {
        return new RPCClient('127.0.0.1', 10240, $class);
    }
}

/**
 * @var Test $test
 */
$test = Factory::create('Test');
$res = $test->say('william', '你好，世界');
var_dump(json_decode($res));
$res = $test->hello();
var_dump(json_decode($res));
$res = $test->world();
var_dump(json_decode($res));
```

```bash
$ php RPCClient.php
string(24) "william: 你好，世界"
string(11) "Hello world"
string(16) "method not exist"
```