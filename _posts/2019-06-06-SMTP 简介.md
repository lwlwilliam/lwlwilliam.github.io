---
title: SMTP 简介
layout: post
category: [计算机网络]
---

SMTP(Simple Mail Transfer Protocol) 是基于文本的简单邮件协议，默认使用 25 端口。下图展示了 SMTP 的基本操作。

![sendMail](/assets/images/20190606/WX20190606-112938.png)

1.  Alice 通过 user agent 指定 Bob 的邮件地址以及编辑邮件，然后发送邮件；

2.  Alice 的 user agent 先把邮件发送到 Alice 的邮件服务器，邮件服务器用把放到消息队列中；

3.  与此同时，Alice 的邮件服务器的客户端（这个邮件服务器既充当服务器也充当客户端）在队列中发现了 Alice 发向 Bob 的邮件，于是就向 Bob 的邮件服务器发起连接；

4.  在连接初始化后，Alice 邮件服务器把 Alice 的邮件通过连接发送出去；

5.  Bob 的邮件服务器收到了来自 Alice 邮件服务器的邮件，把该邮件放到 Bob 的个人邮箱；

6.  Bob 通过 user agent 读取邮件（注意：这里的读取用的并不是 SMTP 协议）。

由此可见，SMTP 不会使用中间邮件服务器发送邮件，即使两个邮件服务器之间在地球的两端。我们可以使用 telnet 进行邮件发送，以下是使用 qq 的 SMTP 服务器发送邮件的完整流程。

*   与 smtp.qq.com 服务器的 25 端口建立连接。

    ```bash
    $ telnet smtp.qq.com 25
    Trying 14.18.245.164...
    Connected to smtp.qq.com
    Escape character is '^]'.
    200 smtp.qq.com Esmtp QQ Mail Server
    ```
   
*   Hello。

    ```bash
    HELO 163.com
    250 smtp.qq.com
    ```
    
*   用户登录。`VXNlcm5hbWU6`和`UGFzc3dvcmQ6`分别是`Username:`和`Password:`的 base64 编码结果，我们输入的用户名和密码也得进行 base64 
编码。一般来说，密码都是授权码，可以在邮件客户端的设置里生成和获取。

    ```bash
    AUTH LOGIN
    334 VXNlcm5hbWU6
    base64(username)
    334 UGFzc3dvcmQ6
    base64(password)
    235 Authentication successful
    ```
    
*   发送人，要对应 SMTP 服务器，qq 的 SMTP 服务器可以发送 foxmail 的邮件。

    ```bash
    MAIL FROM: <username@foxmail.com>
    250 Ok
    ```
    
*   收件人。

    ```bash
    RCPT TO: <username@163.com>
    250 Ok
    ```
    
*   编辑邮件内容并发送。SUBJECT（主题）之后要空一行，接着写邮件正文。正文以单独占一行的`.`为结束。

    ```bash
    DATA
    354 End data with <CR><LF>.<CR><LF>
    FROM: username@foxmail.com
    TO: username@163.com
    SUBJECT: SMTP

    Mail from Iterm.
    .
    250 Ok: queued as
    ```

*   退出。

    ```bash
    QUIT
    221 Bye
    ```

与 HTTP 协议相比，HTTP 协议是`pull`类的协议，从服务器 pull 数据对象；而 SMTP 由是`push`类的协议，向 SMTP 服务器 push 邮件。