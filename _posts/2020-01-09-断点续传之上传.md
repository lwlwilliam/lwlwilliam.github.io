---
title: 断点续传之上传
layout: post
categories: [计算机网络]
keywords: 计算机网络, 断点续传, 上传
---

这篇文章主要讲断点续传的上传原理。

断点续传指的是在文件传输时将文件进行切分，每个部分的传输都是独立的，并且在遇到网络故障时，可以在网络通畅之后继续传输的未曾传输的部分，并不需要重新传输。

根据以上描述，Web 端的文件上传步骤如下。**为了思路的清晰，以下代码十分简陋，不要在项目中这么写**。

### 读取文件

```js
var fileEle = document.querySelector('#file');
var readerFile;
var file;
fileEle.onchange = function() {
    var rd = new FileReader();
    file = this.files[0]; // 这里默认只有一个文件，多文件的话可以自行扩展
    
    rd.onload = function(e) {
        readerFile = e.target.result;
    }
    
    rd.readAsDataURL(file);
}
```

### 切分文件

```js
var start = 0;
var count = 0;
var step = 10240; // 切片大小
var piece;

function getPiece() {
    piece = readerFile.slice(start, start + step);
    return piece;
}
```

### 上传文件

```js
function upload() {
    var fm = new FormData();
    fm.append('name', file.name);
    fm.append('cap', file.size);
    fm.append('len', step);
    fm.append('offset_' + String(count), getPiece());
    
    var xhr = new XMLHttpRequest();
    xhr.onload = function (e) {
        if (e.target.status == 200 && e.target.readyState == 4) {
            count ++;
            start += step;
            if (start < readerFile.length) {
                // 这里自己决定怎么续传
                setTimeout(function() {
                    upload();
                }, 1000);
            } else {
                alert('上传成功');
            }
        }
    }
    
    xhr.open('post', 'http://localhost:8888/upload');
    xhr.send(fm);
}
```

### 上传完成，合并文件

根据前端的`offset_seq`（seq 为序列号，用来确认切片的顺序）字段，可以用数据库的形式将切片分别保存，等确认上传完毕之后，按照顺序合并所有的文件。
