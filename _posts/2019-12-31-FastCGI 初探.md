---
title: FastCGI 初探
layout: post
categories: [计算机网络]
keywords: FastCGI, 网络协议, 计算机网络
---

### 准备

##### Nginx 配置

```
user                         root admin;
worker_processes             2;

events {
    worker_connections       1024;
}

http {
    include                  mime.types;
    default_type             text/html;
    gzip                     on;
    gzip_types               text/css text/x-component application/x-javascript application/javascript text/javascript text/x-js text/richtext image/svg+xml text/plain text/xsd text/xsl text/xml image/x-icon;

    sendfile                 on;

    server {
        listen       80;
        server_name  localhost;
        autoindex    on;
        root         /var/www;
        index        index.html;

        location / {
            try_files        $uri =404;
        }

        # 以 .go 结尾的 url 都通过 fastcgi 转发到 localhost:10000 处
        location ~ \.go$ {
            try_files        $uri =404;
            fastcgi_pass     localhost:10000;
            fastcgi_param    SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include          fastcgi_params;
        }

        try_files $uri $uri.html =404;
    }
}
```

##### Go FastCGI 代码

```go
# main.go
package main

import (
	"fmt"
	"io"
	"net"
	"net/http"
	"net/http/fcgi"
	"os"
)

type FastCGIServer struct {
}

func (s FastCGIServer) ServeHTTP(resp http.ResponseWriter, req *http.Request) {
	for header, values := range req.Header {
		fmt.Println(header, "=>", values)
	}
	defer req.Body.Close()
	io.Copy(os.Stdout, req.Body)

	resp.Write([]byte("<h1>Hello world</h1><p>Welcome to my Go web app."))
}

func main() {
	listener, _ := net.Listen("tcp", "127.0.0.1:10000")
	srv := new(FastCGIServer)
	fcgi.Serve(listener, srv)
}
```

##### 创建将要访问的 Go 文件

```bash
$ sudo touch /var/www/test.go
```

### 说明

Nginx 配置中，主要的配置是：

```
location ~ \.go$ {
    try_files        $uri =404;
    fastcgi_pass     localhost:10000;
    fastcgi_param    SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include          fastcgi_params;
}
```

其中以上配置又以`fastcgi_pass     localhost:10000;`为主，`localhost:10000`就是 Go FastCGI 代码中监听的地址，配置的作用就是在 Nginx 接收客户端以`.go`结尾的 URL 的 HTTP 请求时，将 HTTP 请求封装到 FastCGI 协议，再发送到`localhost:10000`对应的 socket 中；Go 代码接收到 FastCGI 请求，从中解析出 HTTP 请求报文进行相应的业务处理，然后生成 FastCGI 响应报文给 Nginx；Nginx 解析出 FastCGI 响应中的 HTTP 报文，最后将 HTTP 响应报文发送给客户端。

Go 的代码没什么好说的，就是生成 HTML 内容。

由于 Nginx 配置了`root         /var/www;`，所以在`/var/www`中创建一个`test.go`文件，否则会报 404。只有存在请求文件时才能转发到`localhost:10000`。

### 验证

先启动 Nginx 服务器，再运行 Go 程序：

```
$ go run main.go
```

浏览器上访问：

![](/assets/images/20191231/WX20191231-174920.png)


![](/assets/images/20191231/WX20191231-174846.png)


可以看到访问`test.go`时，显示的正是 Go 程序生成的内容。

### 与 CGI 的区别

##### CGI(Common Gateway Interface)

> 工作原理

Web 服务器接收到动态请求时，会启动对应的 CGI 程序；CGI 程序处理完请求后，将数据返回给 Web 服务器；Web 服务器再把结果返回给客户端。

> CGI 特点

1.  高并发时性能差：由于 CGI 程序每次接收到请求时都会启动一个进程，会有较大的开销。

2.  安全性较差。

![](/assets/images/20191231/WX20191231-181630.png)

##### FastCGI(Fast Common Gateway Interface)

FastCGI 是 CGI 的增强版本，由 CGI 发展改进而来，主要用于提高 CGI 程序性能，类似于 CGI。

> 工作原理

Web 服务器启动的同时，加载 FastCGI 进程管理器。FastCGI 初始化之后，启动多个 CGI 解析器进程等待 Web 服务器的连接；Web 服务器接收到动态请求时，FastCGI 进程管理器选择并连接一个 CGI 解析器；Web 服务器会将相关环境变量和标准输入发送到 FastCGI 子进程进行处理；FastCGI 子进程完成处理后将数据按照 CGI 规定的格式返回给 Web 服务器，然后等待下一次请求。

> FastCGI 特点

1.  FastCGI 程序接口采用 C/S 结构，可以将 Web 服务器和脚本解析服务器分开，独立于 Web 服务器运行，提高 Web 服务器的并发性能和安全性。

2.  FastCGI 不依赖于任何 Web 服务器。

3.  FastCGI 程序在修改配置时可以进行平滑重启加载新配置。

4.  常驻内存，不必每次创建新进程，速度较快。

5.  内存消耗较大，注意进程池的数量。

![](/assets/images/20191231/WX20191231-181617.png)
